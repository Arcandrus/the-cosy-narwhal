{% extends "base.html" %}
{% load custom_filters %}
{% block content %}
<!-- checkout/checkout.html -->



<!-- Left side: Order Summary -->
<h2>Your Order</h2>

<hr>
<div class="row align-items-center mb-3">
    <!-- Right side: Delivery Form OR Stripe Payment Widget -->
    <div class="col-6">
        {% if payment_phase %}
        <h2>Complete Payment</h2>
        <p>Please enter your payment details below</p>
        <form id="payment-form">
            <div class="form-control mt-3" id="card-element"><!--Stripe.js injects the Card Element here--></div>
            <button class="btn btn-def mt-3" id="submit">Pay £{{ total_price }}</button>
            <div id="error-message"></div>
        </form>
        <script type="application/json" id="bag-data">{{ bag_json|safe }}</script>
        <span id="total-price" style="display:none;">{{ total_price }}</span>
        <script type="text/javascript">
            const stripe = Stripe('{{ stripe_public_key }}');
            const elements = stripe.elements();
            const cardElement = elements.create('card');
            cardElement.mount('#card-element');

            const form = document.getElementById('payment-form');
            const errorMessage = document.getElementById('error-message');

            // Parse JSON safely from the hidden element with id 'bag-data'
            let bag = {};
            try {
                bag = JSON.parse(document.getElementById('bag-data').textContent);
            } catch (e) {
                errorMessage.textContent = 'Invalid bag data.';
            }

            const totalPrice = parseFloat(document.getElementById('total-price').textContent);

            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const { error, paymentIntent } = await stripe.confirmCardPayment(
                    '{{ client_secret }}', {
                    payment_method: {
                        card: cardElement,
                    }
                }
                );

                if (error) {
                    errorMessage.textContent = error.message;
                } else if (paymentIntent.status === 'succeeded') {
                    // Send order data to backend to save the order
                    fetch("{% url 'save_order' %}", {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": "{{ csrf_token }}",
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            items: bag,
                            total_price: totalPrice,
                        }),
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.status === 'success') {
                                window.location.href = `/checkout/success/${data.order_number}/`;
                            } else {
                                errorMessage.textContent = 'Error saving order data.';
                            }
                        })
                        .catch(() => {
                            errorMessage.textContent = 'Network error saving order data.';
                        });
                }
            });

        </script>

        {% else %}
        <h2>Delivery Information</h2>
        <form method="post" action="{% url 'checkout' %}">
            {% csrf_token %}
            {{ form.as_p }}
            <button class="btn btn-def" type="submit">Continue to Payment</button>
        </form>
        {% endif %}
    </div>
    <div class="col-6">
        <table class="table">
            <tbody>
                {% for product_code, quantity in bag.items %}
                {% with product=product_code|product_by_code %}
                <tr>
                    <td>
                        {% if product.image %}
                        <img class="product-img-small" src="{{ product.image.url }}" alt="{{ product.name }}">
                        {% else %}
                        <img class="product-img-small" src="{{ product.image_url }}" alt="{{ product.name }}">
                        {% endif %}
                    </td>
                    <td>{{ product.name }}</td>
                    <td class="text-center">
                        <span class="product-info-checkout">
                            <strong>Price: </strong>£{{ product.price }}<br>
                            <strong>Quantity: </strong> x{{ quantity }}<br>
                            <strong>Subtotal: </strong>£{{ product.price|multiply:quantity|floatformat:2 }}
                        </span>
                    </td>
                </tr>
                {% endwith %}
                {% empty %}
                <tr>
                    <td colspan="5">Your cart is empty.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <hr>
    </div>
</div>
<div class="row">
    <div class="col-9"></div>
    <div class="col-3 text-end">
        <strong>Grand Total: </strong>£{{ total_price }}
    </div>
</div>

{% endblock %}